{% extends 'base.html.twig' %}

{% block title %}Zaragoza comercio{% endblock %}
{# {% block header %} #}
{# <div style="height: 3rem; background-color: #9b3838"> #}
{# </div> #}
{# {% endblock %} #}
{% block body %}
    <div class="buscador">
        <div class="container-fluid text-center">
            <div class="row" style="color: black">
                <h1>Zaragoza comerio</h1>
                <h3>Cosas flaules y chulas</h3>
                <h5>magic everywhere</h5>
            </div>
        </div>
    </div>

    <div class="barra">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <input type="text" id="search-input" placeholder="Buscar comercios" style="border: none; outline: none;">
                    <i class="fas fa-magnifying-glass fa-lg" style="color: #7e868c"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid" id="search-results">
    </div>

    <div class="row">
        {% for comercio in comercios|default([]) %}
            <div class="col-6 col-md-4 col-lg-3 mt-3" style="width: 20rem;">
                <div class="card shadow-3-strong">
                    <a href="{{ path('app_comercio', {'id': comercio.id}) }}">
                        {% if comercio.fotos|length > 0 %}
                            <img src="{{ asset('storage/' ~ comercio.id ~ '/' ~ comercio.fotos[0].archivo) }}"
                                 class="card-img-top d-flex align-items-center" alt="Foto comercio"
                                 style="border-bottom-left-radius: 4rem; height: 12rem;">
                        {% else %}
                            <!-- Puedes agregar un mensaje o imagen de reemplazo si no hay fotos disponibles -->
                            <p>No hay fotos disponibles</p>
                        {% endif %}
                        <div class="card-body">
                            <p class="card-text">{{ comercio.nombre }}</p>
                            <p class="card-text" style="font-size: small">{{ comercio.descripcion }}</p>
                        </div>
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="categorias">
        <div class="container-fluid">
            <h2>Categorías</h2>
        </div>
    </div>
    <div>
        <div class="container-fluid">
            <h2>Introduce tu comercio</h2>
        </div>
    </div>

    <div>
        <div class="container-fluid">
            <h2>¿Qué es esta mierda?</h2>
        </div>
    </div>

{% endblock %}
{% block js %}

    <script>
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        let timeout;

        searchInput.addEventListener('input', function () {
            // Borra el temporizador existente si existe
            clearTimeout(timeout);

            // Configura un nuevo temporizador para la búsqueda después de 1 segundo
            timeout = setTimeout(function () {
                const searchTerm = searchInput.value;
                const url = '/buscar?search=' + searchTerm;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Limpiar los resultados anteriores
                        searchResults.innerHTML = '';

                        if (data.length === 0) {
                            // No se encontraron resultados sin acentos, intenta con acentos y en la descripción
                            const searchTermWithAccents = removeAccents(searchTerm);
                            const urlWithAccents = '/buscar?search=' + searchTermWithAccents;

                            fetch(urlWithAccents)
                                .then(response => response.json())
                                .then(dataWithAccents => {
                                    dataWithAccents.forEach(comercio => {
                                        const comercioElement = document.createElement('div');
                                        comercioElement.innerHTML = '<a href="/comercio/' + comercio.id + '">' + comercio.nombre + '</a>';
                                        searchResults.appendChild(comercioElement);
                                    });
                                })
                                .catch(error => {
                                    console.error('Error al buscar con acentos y en la descripción:', error);
                                });

                            // Intenta buscar palabras clave en la descripción
                            const urlWithKeywords = '/buscar?search=' + searchTerm + '&searchInDescripcionKeywords=true';

                            fetch(urlWithKeywords)
                                .then(response => response.json())
                                .then(dataWithKeywords => {
                                    dataWithKeywords.forEach(comercio => {
                                        const comercioElement = document.createElement('div');
                                        comercioElement.innerHTML = '<a href="/comercio/' + comercio.id + '">' + comercio.nombre + '</a>';
                                        searchResults.appendChild(comercioElement);
                                    });
                                })
                                .catch(error => {
                                    console.error('Error al buscar palabras clave en la descripción:', error);
                                });
                        } else {
                            data.forEach(comercio => {
                                const comercioElement = document.createElement('div');
                                comercioElement.innerHTML = '<a href="/comercio/' + comercio.id + '">' + comercio.nombre + '</a>';
                                searchResults.appendChild(comercioElement);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al buscar:', error);
                    });
            }, 500); // 1000 milisegundos = 1 segundo
        });

        // Función para eliminar acentos y caracteres especiales
        function removeAccents(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }
    </script>

{% endblock %}
